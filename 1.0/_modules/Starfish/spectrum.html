

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Starfish.spectrum &mdash; Starfish 0.1 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Starfish 0.1 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/>
 

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-5472810-5', 'auto');
  ga('send', 'pageview');

</script>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> Starfish</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../overview.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview.html#obtaining-model-spectra">Obtaining model spectra</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview.html#the-spectral-emulator">The Spectral Emulator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview.html#spectrum-data-formats-and-runtime">Spectrum data formats and runtime</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview.html#the-mcmc-driver-script">The MCMC driver script</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview.html#memory-usage">Memory usage</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../grid_tools.html">Grid Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../grid_tools.html#downloading-model-spectra">Downloading model spectra</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../grid_tools.html#raw-grid-interfaces">Raw Grid Interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../grid_tools.html#hdf5-creators-and-fast-interfaces">HDF5 creators and Fast interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../grid_tools.html#interpolators">Interpolators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../grid_tools.html#instruments">Instruments</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../grid_tools.html#utility-functions">Utility Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../grid_tools.html#exceptions">Exceptions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../spectrum.html">Spectrum</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../spectrum.html#log-lambda-spacing">Log lambda spacing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../spectrum.html#data-spectrum">Data Spectrum</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../emulator.html">Spectral Emulator</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../emulator.html#eigenspectra-decomposition">Eigenspectra decomposition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../emulator.html#optimizing-the-emulator">Optimizing the emulator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../emulator.html#model-spectrum-reconstruction">Model spectrum reconstruction</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../model.html">Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MCMC.html">MCMC</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../MCMC.html#creating-the-parameter-script">Creating the parameter script</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../scripts.html">Scripts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../scripts.html#hdf5-scripts">HDF5 Scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../scripts.html#plotting-scripts">Plotting Scripts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cookbook.html">Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook.html#using-the-linear-interpolator">Using the linear interpolator</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../example_wasp14.html">Example: WASP 14</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../example_wasp14.html#preamble">Preamble</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../example_wasp14.html#just-getting-set-up">Just getting set up.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../example_wasp14.html#generating-the-eigenspectra-and-their-weights">Generating the eigenspectra and their weights</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../example_wasp14.html#using-the-linear-interpolator">Using the linear interpolator</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../example_wasp14_data.html">Example: WASP 14 Data Munging</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../example_wasp14_data.html#preamble">Preamble</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../example_wasp14_data.html#set-up-the-calibration-parameters">Set up the calibration parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../example_wasp14_data.html#spot-check-your-data-and-model-parameters">Spot check your data and model parameters</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../example_wasp14_sampling.html">Example: WASP 14 Sampling</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../example_wasp14_sampling.html#preamble">Preamble</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../example_wasp14_sampling.html#optimize">Optimize</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../example_wasp14_sampling.html#setting-up-an-mcmc-run">Setting up an MCMC run</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../example_wasp14_sampling.html#running-mcmc">Running MCMC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../example_wasp14_sampling.html#sample-with-the-covariance-kernels">Sample with the covariance kernels</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../example_wasp14_sampling.html#generate-local-kernels">Generate local kernels</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../example_wasp14_multi.html">Example: WASP 14 Multiple Orders</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../example_wasp14_multi.html#getting-set-up">Getting set up</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../example_wasp14_multi.html#only-spot-check-the-last-order"># Only spot check the last order</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../example_wasp14_multi.html#mcmc"># MCMC</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Troubleshooting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#problems-generating-model-bad-wavelength-range">Problems generating model: Bad wavelength range</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#nonetype-and-parameters-out-of-range">NoneType and parameters out of range</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#fix-c0-is-incorrectly-disabled"><cite>fix_c0</cite> is incorrectly disabled</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tips_and_tricks.html">Tips and Tricks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tips_and_tricks.html#time-how-long-it-takes-your-script-to-run">Time how long it takes your script to run.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tips_and_tricks.html#tuning-the-mcmc-jump-sizes">Tuning the MCMC jump sizes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tips_and_tricks.html#how-many-cpus-do-you-have">How many CPUs do you have.</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Starfish</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>Starfish.spectrum</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for Starfish.spectrum</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.polynomial</span> <span class="kn">import</span> <span class="n">Chebyshev</span> <span class="k">as</span> <span class="n">Ch</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">InterpolatedUnivariateSpline</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">j1</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="kn">as</span> <span class="nn">sp</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">ascii</span><span class="p">,</span><span class="n">fits</span>
<span class="kn">from</span> <span class="nn">scipy.sparse.linalg</span> <span class="kn">import</span> <span class="n">spsolve</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">Starfish.constants</span> <span class="kn">as</span> <span class="nn">C</span>
<span class="kn">from</span> <span class="nn">Starfish.covariance</span> <span class="kn">import</span> <span class="n">get_dense_C</span>
<span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">cho_factor</span><span class="p">,</span> <span class="n">cho_solve</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="n">log_lam_kws</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">((</span><span class="s">&quot;CDELT1&quot;</span><span class="p">,</span> <span class="s">&quot;CRVAL1&quot;</span><span class="p">,</span> <span class="s">&quot;NAXIS1&quot;</span><span class="p">))</span>
<span class="n">flux_units</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">((</span><span class="s">&quot;f_lam&quot;</span><span class="p">,</span> <span class="s">&quot;f_nu&quot;</span><span class="p">))</span>

<div class="viewcode-block" id="calculate_dv"><a class="viewcode-back" href="../../spectrum.html#Starfish.spectrum.calculate_dv">[docs]</a><span class="k">def</span> <span class="nf">calculate_dv</span><span class="p">(</span><span class="n">wl</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Given a wavelength array, calculate the minimum ``dv`` of the array.</span>

<span class="sd">    :param wl: wavelength array</span>
<span class="sd">    :type wl: np.array</span>

<span class="sd">    :returns: (float) delta-v in units of km/s</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">C</span><span class="o">.</span><span class="n">c_kms</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">wl</span><span class="p">)</span><span class="o">/</span><span class="n">wl</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</div>
<span class="k">def</span> <span class="nf">calculate_dv_dict</span><span class="p">(</span><span class="n">wl_dict</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Given a ``wl_dict``, calculate the velocity spacing.</span>

<span class="sd">    :param wl_dict: wavelength dictionary</span>
<span class="sd">    :type wl_dict: dict</span>

<span class="sd">    :returns: (float) delta-v in units of km/s</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">CDELT1</span> <span class="o">=</span> <span class="n">wl_dict</span><span class="p">[</span><span class="s">&quot;CDELT1&quot;</span><span class="p">]</span>
    <span class="n">dv</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">c_kms</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">CDELT1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dv</span>

<div class="viewcode-block" id="create_log_lam_grid"><a class="viewcode-back" href="../../spectrum.html#Starfish.spectrum.create_log_lam_grid">[docs]</a><span class="k">def</span> <span class="nf">create_log_lam_grid</span><span class="p">(</span><span class="n">dv</span><span class="p">,</span> <span class="n">wl_start</span><span class="o">=</span><span class="mf">3000.</span><span class="p">,</span> <span class="n">wl_end</span><span class="o">=</span><span class="mf">13000.</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create a log lambda spaced grid with ``N_points`` equal to a power of 2 for</span>
<span class="sd">    ease of FFT.</span>

<span class="sd">    :param wl_start: starting wavelength (inclusive)</span>
<span class="sd">    :type wl_start: float, AA</span>
<span class="sd">    :param wl_end: ending wavelength (inclusive)</span>
<span class="sd">    :type wl_end: float, AA</span>
<span class="sd">    :param dv: upper bound on the size of the velocity spacing (in km/s)</span>
<span class="sd">    :type dv: float</span>

<span class="sd">    :returns: a wavelength dictionary containing the specified properties. Note</span>
<span class="sd">        that the returned dv will be &lt;= specified dv.</span>
<span class="sd">    :rtype: wl_dict</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">assert</span> <span class="n">wl_start</span> <span class="o">&lt;</span> <span class="n">wl_end</span><span class="p">,</span> <span class="s">&quot;wl_start must be smaller than wl_end&quot;</span>

    <span class="n">CDELT_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dv</span><span class="o">/</span><span class="n">C</span><span class="o">.</span><span class="n">c_kms</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="n">CRVAL1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">wl_start</span><span class="p">)</span>
    <span class="n">CRVALN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">wl_end</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="p">(</span><span class="n">CRVALN</span> <span class="o">-</span> <span class="n">CRVAL1</span><span class="p">)</span> <span class="o">/</span> <span class="n">CDELT_temp</span>
    <span class="n">NAXIS1</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">while</span> <span class="n">NAXIS1</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">:</span> <span class="c">#Make NAXIS1 an integer power of 2 for FFT purposes</span>
        <span class="n">NAXIS1</span> <span class="o">*=</span> <span class="mi">2</span>

    <span class="n">CDELT1</span> <span class="o">=</span> <span class="p">(</span><span class="n">CRVALN</span> <span class="o">-</span> <span class="n">CRVAL1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">NAXIS1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NAXIS1</span><span class="p">)</span>
    <span class="n">wl</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">CRVAL1</span> <span class="o">+</span> <span class="n">CDELT1</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">&quot;wl&quot;</span><span class="p">:</span> <span class="n">wl</span><span class="p">,</span> <span class="s">&quot;CRVAL1&quot;</span><span class="p">:</span> <span class="n">CRVAL1</span><span class="p">,</span> <span class="s">&quot;CDELT1&quot;</span><span class="p">:</span> <span class="n">CDELT1</span><span class="p">,</span> <span class="s">&quot;NAXIS1&quot;</span><span class="p">:</span> <span class="n">NAXIS1</span><span class="p">}</span>

</div>
<span class="k">def</span> <span class="nf">rfftfreq</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the Discrete Fourier Transform sample frequencies</span>
<span class="sd">    (for usage with rfft, irfft).</span>

<span class="sd">    The returned float array `f` contains the frequency bin centers in cycles</span>
<span class="sd">    per unit of the sample spacing (with zero at the start). For instance, if</span>
<span class="sd">    the sample spacing is in seconds, then the frequency unit is cycles/second.</span>

<span class="sd">    Given a window length `n` and a sample spacing `d`::</span>

<span class="sd">    f = [0, 1, ..., n/2-1, n/2] / (d*n) if n is even</span>
<span class="sd">    f = [0, 1, ..., (n-1)/2-1, (n-1)/2] / (d*n) if n is odd</span>

<span class="sd">    Unlike `fftfreq` (but like `scipy.fftpack.rfftfreq`)</span>
<span class="sd">    the Nyquist frequency component is considered to be positive.</span>

<span class="sd">    :param n : Window length</span>
<span class="sd">    :type n: int</span>
<span class="sd">    :param d: Sample spacing (inverse of the sampling rate). Defaults to 1.</span>
<span class="sd">    ;type d: scalar, optional</span>
<span class="sd">    :returns: f, Array of length ``n//2 + 1`` containing the sample frequencies.</span>
<span class="sd">    :rtype: ndarray</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;n should be an integer&quot;</span><span class="p">)</span>
    <span class="n">val</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">n</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span> <span class="o">*</span> <span class="n">val</span>

<span class="k">def</span> <span class="nf">create_mask</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Given a wavelength array (1D or 2D) and an ascii file containing the regions</span>
<span class="sd">    that one wishes to mask out, return a boolean array of indices for which</span>
<span class="sd">    wavelengths to KEEP in the calculation.</span>

<span class="sd">    :param wl: wavelength array (in AA)</span>
<span class="sd">    :param fname: filename of masking array</span>

<span class="sd">    :returns mask: boolean mask</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&quot;bool&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="c"># starting and ending indices</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">row</span>
        <span class="k">print</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

        <span class="c"># All region of wavelength that do not fall in this range</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">wl</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">wl</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">ind</span>


<div class="viewcode-block" id="DataSpectrum"><a class="viewcode-back" href="../../spectrum.html#Starfish.spectrum.DataSpectrum">[docs]</a><span class="k">class</span> <span class="nc">DataSpectrum</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Object to manipulate the data spectrum.</span>

<span class="sd">    :param wls: wavelength (in AA)</span>
<span class="sd">    :type wls: 1D or 2D np.array</span>
<span class="sd">    :param fls: flux (in f_lam)</span>
<span class="sd">    :type fls: 1D or 2D np.array</span>
<span class="sd">    :param sigmas: Poisson noise (in f_lam)</span>
<span class="sd">    :type sigmas: 1D or 2D np.array</span>
<span class="sd">    :param masks: Mask to blot out bad pixels or emission regions.</span>
<span class="sd">    :type masks: 1D or 2D np.array of boolean values</span>

<span class="sd">    If the wl, fl, are provided as 1D arrays (say for a single order), they will be converted to 2D arrays with length 1</span>
<span class="sd">    in the 0-axis.</span>

<span class="sd">    .. note::</span>

<span class="sd">       For now, the DataSpectrum wls, fls, sigmas, and masks must be a rectangular grid. No ragged Echelle orders allowed.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wls</span><span class="p">,</span> <span class="n">fls</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">,</span> <span class="n">masks</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">orders</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">wls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">fls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">sigmas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span> <span class="k">if</span> <span class="n">masks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wls</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wls</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">fls</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s">&quot;flux array incompatible shape.&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s">&quot;sigma array incompatible shape.&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s">&quot;mask array incompatible shape.&quot;</span>

        <span class="k">if</span> <span class="n">orders</span> <span class="o">!=</span> <span class="s">&#39;all&#39;</span><span class="p">:</span>
            <span class="c">#can either be a numpy array or a list</span>
            <span class="n">orders</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span> <span class="c">#just to make sure</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wls</span><span class="p">[</span><span class="n">orders</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fls</span><span class="p">[</span><span class="n">orders</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span><span class="p">[</span><span class="n">orders</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="n">orders</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wls</span><span class="o">.</span><span class="n">shape</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="n">orders</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="DataSpectrum.open"><a class="viewcode-back" href="../../spectrum.html#Starfish.spectrum.DataSpectrum.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">orders</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Load a spectrum from a directory link pointing to HDF5 output from EchelleTools processing.</span>

<span class="sd">        :param base_file: HDF5 file containing files on disk.</span>
<span class="sd">        :type base_file: string</span>
<span class="sd">        :returns: DataSpectrum</span>
<span class="sd">        :param orders: Which orders should we be fitting?</span>
<span class="sd">        :type orders: np.array of indexes</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c">#Open the HDF5 file, try to load each of these values.</span>
        <span class="kn">import</span> <span class="nn">h5py</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdf5</span><span class="p">:</span>
            <span class="n">wls</span> <span class="o">=</span> <span class="n">hdf5</span><span class="p">[</span><span class="s">&quot;wls&quot;</span><span class="p">][:]</span>
            <span class="n">fls</span> <span class="o">=</span> <span class="n">hdf5</span><span class="p">[</span><span class="s">&quot;fls&quot;</span><span class="p">][:]</span>
            <span class="n">sigmas</span> <span class="o">=</span> <span class="n">hdf5</span><span class="p">[</span><span class="s">&quot;sigmas&quot;</span><span class="p">][:]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c">#Try to see if masks is available, otherwise return an all-true mask.</span>
                <span class="n">masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hdf5</span><span class="p">[</span><span class="s">&quot;masks&quot;</span><span class="p">][:],</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&quot;bool&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">wls</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&quot;bool&quot;</span><span class="p">)</span>

        <span class="c">#Although the actual fluxes and errors may be reasonably stored as float32, we need to do all of the calculations</span>
        <span class="c">#in float64, and so we convert here.</span>
        <span class="c">#The wls must be stored as float64, because of precise velocity issues.</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">wls</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">fls</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">sigmas</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">masks</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="nb">file</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="DataSpectrum.open_npy"><a class="viewcode-back" href="../../spectrum.html#Starfish.spectrum.DataSpectrum.open_npy">[docs]</a>    <span class="k">def</span> <span class="nf">open_npy</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">base_file</span><span class="p">,</span> <span class="n">orders</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Load a spectrum from a directory link pointing to .npy output from EchelleTools processing.</span>

<span class="sd">        :param base_file: base path name to be appended with &quot;.wls.npy&quot;, &quot;.fls.npy&quot;, &quot;.sigmas.npy&quot;, and &quot;.masks.npy&quot; to load files from disk.</span>
<span class="sd">        :type base_file: string</span>
<span class="sd">        :returns: DataSpectrum</span>
<span class="sd">        :param orders: Which orders should we be fitting?</span>
<span class="sd">        :type orders: np.array of indexes</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">wls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">base_file</span> <span class="o">+</span> <span class="s">&quot;.wls.npy&quot;</span><span class="p">)</span>
        <span class="n">fls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">base_file</span> <span class="o">+</span> <span class="s">&quot;.fls.npy&quot;</span><span class="p">)</span>
        <span class="n">sigmas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">base_file</span> <span class="o">+</span> <span class="s">&quot;.sigmas.npy&quot;</span><span class="p">)</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">base_file</span> <span class="o">+</span> <span class="s">&quot;.masks.npy&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">wls</span><span class="p">,</span> <span class="n">fls</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">orders</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="DataSpectrum.add_mask"><a class="viewcode-back" href="../../spectrum.html#Starfish.spectrum.DataSpectrum.add_mask">[docs]</a>    <span class="k">def</span> <span class="nf">add_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_mask</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Given a mask with the same self.shape, update self.masks to include the union with this new mask.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">new_mask</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s">&quot;new_mask shape ({}) must be the same shape as spectrum ({}).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">new_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">&amp;</span> <span class="n">new_mask</span>
</div>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;DataSpectrum object {} with shape {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</div>
<span class="k">class</span> <span class="nc">Mask</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Mask to apply to DataSpectrum</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">orders</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="s">&quot;masks must be a numpy array&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">orders</span> <span class="o">!=</span> <span class="s">&#39;all&#39;</span><span class="p">:</span>
            <span class="c">#can either be a numpy array or a list</span>
            <span class="n">orders</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span> <span class="c">#just to make sure</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="n">orders</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="n">orders</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">orders</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Load a Mask from a directory link pointing to HDF5 file output from EchelleTools or Generate_mask.ipynb</span>
<span class="sd">        processing.</span>

<span class="sd">        :param file: HDF5 file containing files on disk.</span>
<span class="sd">        :type file: string</span>
<span class="sd">        :returns: DataSpectrum</span>
<span class="sd">        :param orders: Which orders should we be fitting?</span>
<span class="sd">        :type orders: np.array of indexes</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">import</span> <span class="nn">h5py</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdf5</span><span class="p">:</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hdf5</span><span class="p">[</span><span class="s">&quot;masks&quot;</span><span class="p">][:],</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&quot;bool&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">orders</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ChebyshevSpectrum</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A DataSpectrum-like object which multiplies downsampled fls to account for imperfect flux calibration issues.</span>

<span class="sd">    :param DataSpectrum: take shape from.</span>
<span class="sd">    :type DataSpectrum: :obj:`DataSpectrum` object</span>

<span class="sd">    If DataSpectrum.norders == 1, then only c1, c2, and c3 are required. Otherwise c0 is also reqired for each order.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">DataSpectrum</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">npoly</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wl</span> <span class="o">=</span> <span class="n">DataSpectrum</span><span class="o">.</span><span class="n">wls</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">len_wl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fix_c0</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">DataSpectrum</span><span class="o">.</span><span class="n">wls</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span> <span class="c">#Fix the last c0</span>

        <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">len_wl</span><span class="p">)</span>

        <span class="c">#Create Ch1, etc... for each coefficient in npoly excepting logc0</span>
        <span class="c">#Evaluate these and stuff them into self.T</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">npoly</span><span class="p">):</span>
            <span class="c"># print(&quot;i = &quot;, i)</span>
            <span class="n">coeff</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">coeff</span>
            <span class="n">Chtemp</span> <span class="o">=</span> <span class="n">Ch</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">len_wl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">Ttemp</span> <span class="o">=</span> <span class="n">Chtemp</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">+=</span> <span class="p">[</span><span class="n">Ttemp</span><span class="p">]</span>

        <span class="c"># Ch1 = Ch([0, 1], domain=[0, len_wl - 1])</span>
        <span class="c"># T1 = Ch1(xs)</span>
        <span class="c"># Ch2 = Ch([0, 0, 1], domain=[0, len_wl - 1])</span>
        <span class="c"># T2 = Ch2(xs)</span>
        <span class="c"># Ch3 = Ch([0, 0, 0, 1], domain=[0, len_wl - 1])</span>
        <span class="c"># T3 = Ch3(xs)</span>

        <span class="c"># self.T = np.array([T1, T2, T3])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npoly</span> <span class="o">=</span> <span class="n">npoly</span>
        <span class="c"># assert self.npoly == 4, &quot;Only handling order 4 Chebyshev for now.&quot;</span>

        <span class="c">#Dummy holders for a flat spectrum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">len_wl</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span>
        <span class="c">#self.c0s = np.ones(self.norders)</span>
        <span class="c">#self.cns = np.zeros((self.norders, self.npoly - 1))</span>
        <span class="c">#self.TT = np.einsum(&quot;in,jn-&gt;ijn&quot;, T, T)</span>

        <span class="c">##Priors</span>
        <span class="c">##    mu = np.array([0, 0, 0])</span>
        <span class="c">##    D = sigmac ** (-2) * np.eye(3)</span>
        <span class="c">##    Dmu = np.einsum(&quot;ij,j-&gt;j&quot;, D, mu)</span>
        <span class="c">##    muDmu = np.einsum(&quot;j,j-&gt;&quot;, mu, Dmu)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Given a dictionary of coefs, create a k array to multiply against model fls</span>

<span class="sd">        :param p: array of coefficients</span>
<span class="sd">        :type p: 1D np.array</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c">#Fix the last order c0 to 1.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_c0</span><span class="p">:</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">cns</span> <span class="o">=</span> <span class="n">p</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cns</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c">#now create polynomials for each order, and multiply through fls</span>
        <span class="c">#print(&quot;T shape&quot;, self.T.shape)</span>
        <span class="c">#print(&quot;cns shape&quot;, cns.shape)</span>

        <span class="n">Tc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cns</span><span class="p">)</span> <span class="c">#self.T.T is the transpose of self.T</span>
        <span class="c">#print(&quot;Tc shape&quot;, Tc.shape)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">c0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">Tc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>

    <span class="k">def</span> <span class="nf">revert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_last</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013-15, Ian Czekala.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>