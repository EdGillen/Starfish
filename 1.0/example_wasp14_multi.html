

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Example: WASP 14 Multiple Orders &mdash; Starfish 0.1 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Starfish 0.1 documentation" href="index.html"/>
        <link rel="next" title="Troubleshooting" href="troubleshooting.html"/>
        <link rel="prev" title="Example: WASP 14 Sampling" href="example_wasp14_sampling.html"/>
 

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-5472810-5', 'auto');
  ga('send', 'pageview');

</script>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="index.html" class="fa fa-home"> Starfish</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="overview.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.html#obtaining-model-spectra">Obtaining model spectra</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.html#the-spectral-emulator">The Spectral Emulator</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.html#spectrum-data-formats-and-runtime">Spectrum data formats and runtime</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.html#the-mcmc-driver-script">The MCMC driver script</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.html#memory-usage">Memory usage</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="grid_tools.html">Grid Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="grid_tools.html#downloading-model-spectra">Downloading model spectra</a></li>
<li class="toctree-l2"><a class="reference internal" href="grid_tools.html#raw-grid-interfaces">Raw Grid Interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="grid_tools.html#hdf5-creators-and-fast-interfaces">HDF5 creators and Fast interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="grid_tools.html#interpolators">Interpolators</a></li>
<li class="toctree-l2"><a class="reference internal" href="grid_tools.html#instruments">Instruments</a></li>
<li class="toctree-l2"><a class="reference internal" href="grid_tools.html#utility-functions">Utility Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="grid_tools.html#exceptions">Exceptions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="spectrum.html">Spectrum</a><ul>
<li class="toctree-l2"><a class="reference internal" href="spectrum.html#log-lambda-spacing">Log lambda spacing</a></li>
<li class="toctree-l2"><a class="reference internal" href="spectrum.html#data-spectrum">Data Spectrum</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="emulator.html">Spectral Emulator</a><ul>
<li class="toctree-l2"><a class="reference internal" href="emulator.html#eigenspectra-decomposition">Eigenspectra decomposition</a></li>
<li class="toctree-l2"><a class="reference internal" href="emulator.html#optimizing-the-emulator">Optimizing the emulator</a></li>
<li class="toctree-l2"><a class="reference internal" href="emulator.html#model-spectrum-reconstruction">Model spectrum reconstruction</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="model.html">Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="MCMC.html">MCMC</a><ul>
<li class="toctree-l2"><a class="reference internal" href="MCMC.html#creating-the-parameter-script">Creating the parameter script</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="scripts.html">Scripts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="scripts.html#hdf5-scripts">HDF5 Scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="scripts.html#plotting-scripts">Plotting Scripts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cookbook.html">Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="cookbook.html#using-the-linear-interpolator">Using the linear interpolator</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="example_wasp14.html">Example: WASP 14</a><ul>
<li class="toctree-l2"><a class="reference internal" href="example_wasp14.html#preamble">Preamble</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_wasp14.html#just-getting-set-up">Just getting set up.</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_wasp14.html#generating-the-eigenspectra-and-their-weights">Generating the eigenspectra and their weights</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_wasp14.html#using-the-linear-interpolator">Using the linear interpolator</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="example_wasp14_data.html">Example: WASP 14 Data Munging</a><ul>
<li class="toctree-l2"><a class="reference internal" href="example_wasp14_data.html#preamble">Preamble</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_wasp14_data.html#set-up-the-calibration-parameters">Set up the calibration parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_wasp14_data.html#spot-check-your-data-and-model-parameters">Spot check your data and model parameters</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="example_wasp14_sampling.html">Example: WASP 14 Sampling</a><ul>
<li class="toctree-l2"><a class="reference internal" href="example_wasp14_sampling.html#preamble">Preamble</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_wasp14_sampling.html#optimize">Optimize</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_wasp14_sampling.html#setting-up-an-mcmc-run">Setting up an MCMC run</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_wasp14_sampling.html#running-mcmc">Running MCMC</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_wasp14_sampling.html#sample-with-the-covariance-kernels">Sample with the covariance kernels</a></li>
<li class="toctree-l2"><a class="reference internal" href="example_wasp14_sampling.html#generate-local-kernels">Generate local kernels</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Example: WASP 14 Multiple Orders</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#getting-set-up">Getting set up</a></li>
<li class="toctree-l2"><a class="reference internal" href="#only-spot-check-the-last-order"># Only spot check the last order</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mcmc"># MCMC</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#problems-generating-model-bad-wavelength-range">Problems generating model: Bad wavelength range</a></li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#nonetype-and-parameters-out-of-range">NoneType and parameters out of range</a></li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#fix-c0-is-incorrectly-disabled"><cite>fix_c0</cite> is incorrectly disabled</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tips_and_tricks.html">Tips and Tricks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="tips_and_tricks.html#time-how-long-it-takes-your-script-to-run">Time how long it takes your script to run.</a></li>
<li class="toctree-l2"><a class="reference internal" href="tips_and_tricks.html#tuning-the-mcmc-jump-sizes">Tuning the MCMC jump sizes</a></li>
<li class="toctree-l2"><a class="reference internal" href="tips_and_tricks.html#how-many-cpus-do-you-have">How many CPUs do you have.</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Starfish</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Example: WASP 14 Multiple Orders</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="_sources/example_wasp14_multi.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="example-wasp-14-multiple-orders">
<h1>Example: WASP 14 Multiple Orders<a class="headerlink" href="#example-wasp-14-multiple-orders" title="Permalink to this headline">¶</a></h1>
<p>This is an example of running Starfish on multiple spectral orders with shared stellar properties.  I will mainly focus on the parts of the example that are different from Example 1.  This example assumes you have already performed Example 1 a-c.</p>
<div class="section" id="getting-set-up">
<h2>Getting set up<a class="headerlink" href="#getting-set-up" title="Permalink to this headline">¶</a></h2>
<p>The first step is to copy the configuration and parameter files from Example 1 (<cite>demo1/</cite>) into this directory (<cite>demo2/</cite>).  We want to use the output parameter values from the previous run as the guesses for this run.</p>
<p>Copy from demo1 to demo2:</p>
<ol class="arabic simple">
<li><cite>config.yaml</cite></li>
<li><cite>data/</cite></li>
<li>The directory structure</li>
</ol>
<p>Then we modify our configuration file to the desired orders and wavelengths:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># YAML configuration script</span>

<span class="hll">    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">wasp14_trial1002</span>
</span>
    <span class="l-Scalar-Plain">data</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">grid_name</span><span class="p-Indicator">:</span> <span class="s">&quot;PHOENIX&quot;</span>
      <span class="l-Scalar-Plain">files</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;data/WASP14/WASP14-2009-06-14.hdf5&quot;</span><span class="p-Indicator">]</span>
      <span class="l-Scalar-Plain">instruments</span> <span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;TRES&quot;</span><span class="p-Indicator">]</span>
<span class="hll">      <span class="l-Scalar-Plain">orders</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">21</span><span class="p-Indicator">,</span> <span class="nv">22</span><span class="p-Indicator">,</span> <span class="nv">23</span><span class="p-Indicator">,</span> <span class="nv">24</span><span class="p-Indicator">]</span>
</span>
    <span class="l-Scalar-Plain">outdir</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output/</span>

    <span class="l-Scalar-Plain">plotdir</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">plots/</span>

    <span class="c1"># The parameters defining your raw spectral library live here.</span>
    <span class="l-Scalar-Plain">grid</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">raw_path</span><span class="p-Indicator">:</span> <span class="s">&quot;/Users/gully/GitHub/Starfish/libraries/raw/PHOENIX/&quot;</span>
      <span class="l-Scalar-Plain">hdf5_path</span><span class="p-Indicator">:</span> <span class="s">&quot;libraries/PHOENIX_TRES_test.hdf5&quot;</span>
      <span class="l-Scalar-Plain">parname</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;temp&quot;</span><span class="p-Indicator">,</span> <span class="s">&quot;logg&quot;</span><span class="p-Indicator">,</span> <span class="s">&quot;Z&quot;</span><span class="p-Indicator">]</span>
      <span class="l-Scalar-Plain">key_name</span><span class="p-Indicator">:</span> <span class="s">&quot;t{0:.0f}g{1:.1f}z{2:.1f}&quot;</span> <span class="c1"># Specifies how the params are stored</span>
      <span class="c1"># in the HDF5 file</span>
<span class="hll">      <span class="l-Scalar-Plain">parrange</span><span class="p-Indicator">:</span> <span class="p-Indicator">[[</span><span class="nv">6000</span><span class="p-Indicator">,</span> <span class="nv">6400</span><span class="p-Indicator">],</span> <span class="p-Indicator">[</span><span class="nv">4.0</span><span class="p-Indicator">,</span> <span class="nv">5.0</span><span class="p-Indicator">],</span> <span class="p-Indicator">[</span><span class="nv">-1.0</span><span class="p-Indicator">,</span> <span class="nv">0.0</span><span class="p-Indicator">]]</span>
</span><span class="hll">      <span class="l-Scalar-Plain">wl_range</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">4975</span><span class="p-Indicator">,</span> <span class="nv">5415</span><span class="p-Indicator">]</span>
</span>      <span class="l-Scalar-Plain">buffer</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">50.</span> <span class="c1"># AA</span>
</pre></div>
</div>
<p>In this example I will optimize the spectral emulator with <cite>emcee</cite> MCMC sampling rather than the <cite>fmin</cite> optimization.  The main virtue of emcee, from a practical standpoint, is that it does not require user intervention (<cite>fmin</cite> usually hits a 10,000 max-iterations limit, in my experience).  So I ran <cite>pca.py &#8211;optimize=emcee &#8211;samples=5000</cite>, which took about 6 hours on my Macbook Pro.  This was probably overkill.  Recall that this process is simply optimizing the hyperparameters for the amplitude and scale of the Gaussian Process fit of the eigenspectra weights.  Here is an example image:</p>
<img alt="_images/triangle_0.png" src="_images/triangle_0.png" />
</div>
<div class="section" id="only-spot-check-the-last-order">
<h2># Only spot check the last order<a class="headerlink" href="#only-spot-check-the-last-order" title="Permalink to this headline">¶</a></h2>
<p>Only spot check the last order.  Why?  Because this is the order in which the <span class="math">\(c^{0}\)</span> term is fixed.  So adjust <strong>logOmega</strong> in the <cite>config.yaml</cite> file until the continuum levels match up.  The continuum mismatches in the other orders will be taken up by the non-zero <span class="math">\(c^{0}\)</span> term in <span class="math">\(\phi{P}\)</span>.  I suspect it is faster to do this by eye, than letting the computer optimize for you.  I like to make a tweak and then run:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>star.py --generate<span class="p">;</span> splot.py s0_o24spec.json --matplotlib<span class="p">;</span> open plots/s0_o24spec.json.png
</pre></div>
</div>
<p>I also hand-adjusted my <cite>theta.json</cite> file, since the theta optimization was taking a long time.  The <cite>optimize=Cheb</cite> command works fine because the problem structure is natively parallelized.</p>
</div>
<div class="section" id="mcmc">
<h2># MCMC<a class="headerlink" href="#mcmc" title="Permalink to this headline">¶</a></h2>
<p>Get your run01 directory set up, and edit the <cite>config.yaml</cite> as we did in the previous example.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ls
config.yaml    s0_o21         s0_o22         s0_o23         s0_o24
plots          s0_o21phi.json s0_o22phi.json s0_o23phi.json s0_o24phi.json
</pre></div>
</div>
<p>Five hundred ThetaCheb samples took 36 minutes on my Macbook pro.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">time </span>star.py --sample<span class="o">=</span>ThetaCheb --samples<span class="o">=</span>500
Final <span class="o">[</span>  6.21445629e+03   4.21662234e+00  -2.70602364e-01  -4.79946024e+00
   5.80021176e+00  -1.27221067e+01<span class="o">]</span>

real  36m12.803s
user  90m17.047s
sys 12m43.253s
</pre></div>
</div>
<p>As usual, hand-edit your <cite>config.yaml</cite> file and <cite>phi.json</cite> files with your best guess for revised stellar and calibration parameters.  Then you can introduce yet-more-parameters.  It took my computer 40 minutes to run 500 samples with all parameters:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">time </span>star.py --sample<span class="o">=</span>ThetaPhi --samples<span class="o">=</span>500

Final <span class="o">[</span>  6.38428451e+03   4.18315434e+00  -3.21968427e-01  -4.88951948e+00
   5.33927051e+00  -1.27197478e+01<span class="o">]</span>

real  40m17.345s
user  106m42.716s
sys 14m27.443s
</pre></div>
</div>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="troubleshooting.html" class="btn btn-neutral float-right" title="Troubleshooting">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="example_wasp14_sampling.html" class="btn btn-neutral" title="Example: WASP 14 Sampling"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013-15, Ian Czekala.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>